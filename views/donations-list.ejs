<%- include("partials/header") %>
<%- include("partials/nav") %>

<div class="page-header">
    <h1 class="section-header">Donations</h1>

    <% if (user && user.level === "M") { %>
        <a class="btn btn-primary add-btn" href="/donations/edit">Add Donation</a>
    <% } %>
</div>

<div class="search-bar">
    <form method="GET" action="/donations" class="search-bar">
        <input type="text" name="search" placeholder="Search..." value="<%= search %>">
        <button class="btn btn-primary" type="submit">Search</button>
        <a class="btn btn-secondary" href="<%= clearPath %>">Clear</a>
    </form>
</div>

<div class="card">
    <table class="styled-table">
        <thead>
            <tr>
                <th>Email</th>
                <th>Date</th>
                <th>Amount</th>

                <% if (user && user.level === "M") { %>
                    <th class="actions-header">Actions</th>
                <% } %>
            </tr>
        </thead>

        <tbody>
            <% donations.forEach(d => { %>

                <% 
                    const cleanDate = (d["Donation Date"] && d["Donation Date"] !== "UNKNOWN_DATE")
                        ? d["Donation Date"]
                        : "";

                    const cleanAmount = d["Donation Amount"]
                        ? String(d["Donation Amount"]).replace(/\$/g, "").trim()
                        : "";
                %>

                <tr>
                    <td><%= d.ParticipantEmail %></td>

                    <!-- ✅ Hides UNKNOWN_DATE -->
                    <td><%= cleanDate %></td>

                    <!-- ✅ Forces ONE clean $ -->
                    <td>$<%= cleanAmount %></td>

                    <% if (user && user.level === "M") { %>
                        <td class="action-buttons">
                            <a class="btn btn-secondary btn-sm"
                               href="/donations/edit/<%= d.ParticipantEmail %>/<%= encodeURIComponent(d["Donation Date"]) %>">
                               Edit
                            </a>

                            <form method="POST"
                                  action="/donations/delete/<%= d.ParticipantEmail %>/<%= encodeURIComponent(d["Donation Date"]) %>"
                                  class="inline-form">
                                <button class="btn btn-danger btn-sm">Delete</button>
                            </form>
                        </td>
                    <% } %>
                </tr>
            <% }) %>
        </tbody>
    </table>
</div>
