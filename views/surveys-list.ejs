<%- include("partials/header") %>
<%- include("partials/nav") %>

<h1 class="section-header">Surveys</h1>

<div class="card">

    <% if (surveys && surveys.length > 0) { %>

        <table class="styled-table survey-table">
            <thead>
                <tr>
                    <th>Email</th>
                    <th>Event Name</th>
                    <th>Start</th>
                    <th>Satisfaction</th>
                    <th>Usefulness</th>
                    <th>Instructor</th>
                    <th>Recommend</th>
                    <th>Overall</th>
                    <th>NPS</th>
                    <th>Comments</th>
                    <th>Actions</th>
                </tr>
            </thead>

            <tbody>

            <% surveys.forEach(s => { 
                 if (!s.SurveySatisfactionScore) return;    // HIDE EMPTY SURVEYS
            %>

                <tr>
                    <td><%= s.ParticipantEmail %></td>
                    <td><%= s.EventName %></td>
                    <td><%= s.EventDateTimeStart %></td>
                    <td><%= s.SurveySatisfactionScore %></td>
                    <td><%= s.SurveyUsefulnessScore %></td>
                    <td><%= s.SurveyInstructorScore %></td>
                    <td><%= s.SurveyRecommendationScore %></td>
                    <td><%= s.SurveyOverallScore %></td>

                    <!-- NPS AS COLOR DOT -->
                    <td class="nps-cell">
                        <% 
                            const bucketRaw = (s.SurveyNPSBucket || "").trim();
                            let bucket = bucketRaw.replace(/\s+/g, " "); // collapse any weird newlines
                        %>

                        <% if (bucket === "Promoter") { %>
                            <span class="nps-dot nps-promoter" title="Promoter"></span>
                        <% } else if (bucket === "Passive") { %>
                            <span class="nps-dot nps-passive" title="Passive"></span>
                        <% } else if (bucket === "Detractor") { %>
                            <span class="nps-dot nps-detractor" title="Detractor"></span>
                        <% } else { %>
                            <span class="nps-none">â€“</span>
                        <% } %>
                    </td>

                    <!-- COMMENTS COLUMN -->
                    <td>
                        <% if (s.SurveyComments && s.SurveyComments.length > 0) { %>
                            <button class="btn btn-small btn-secondary"
                                    data-comment="<%= s.SurveyComments.replace(/"/g, '&quot;') %>"
                                    onclick="showComment(this.dataset.comment)">
                                View
                            </button>
                        <% } else { %>
                            <span>No comments</span>
                        <% } %>
                    </td>

                    <!-- ACTIONS COLUMN -->
                    <td class="actions-column">
                        <a class="btn btn-secondary btn-small" href="/surveys/edit/<%= s.SurveyID %>">Edit</a>

                        <% if (user.level === "M") { %>
                            <form action="/surveys/delete/<%= s.SurveyID %>" method="POST" style="display:inline;">
                                <button class="btn btn-danger btn-small"
                                        onclick="return confirm('Delete survey?');">Delete</button>
                            </form>
                        <% } %>
                    </td>

                </tr>

            <% }) %>

            </tbody>
        </table>

        <!-- NPS LEGEND -->
        <div class="nps-legend">
            <span><span class="nps-dot nps-promoter"></span> Promoter</span>
            <span><span class="nps-dot nps-passive"></span> Passive</span>
            <span><span class="nps-dot nps-detractor"></span> Detractor</span>
        </div>

    <% } else { %>
        <p>No surveys recorded.</p>
    <% } %>

</div>

<% if (user.level === "M") { %>
    <a href="/surveys/edit" class="btn btn-primary">Add Survey</a>
<% } %>

<!-- MODAL -->
<div id="commentModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h2>Survey Comment</h2>
        <p id="commentText"></p>
        <button class="btn btn-primary" onclick="closeComment()">Close</button>
    </div>
</div>

<script>
    function showComment(text) {
        document.getElementById("commentText").innerText = text;
        document.getElementById("commentModal").style.display = "flex";
    }
    function closeComment() {
        document.getElementById("commentModal").style.display = "none";
    }
</script>

<%- include("partials/footer") %>
