<%- include("partials/header") %>
<%- include("partials/nav") %>

<h1 class="section-header">Surveys</h1>

<div class="card">

    <% if (surveys && surveys.length > 0) { %>

        <table class="styled-table survey-table">
            <thead>
                <tr>
                    <th>Email</th>
                    <th>Event Name</th>
                    <th>Start</th>
                    <th>Satisfaction</th>
                    <th>Usefulness</th>
                    <th>Instructor</th>
                    <th>Recommend</th>
                    <th>Overall</th>
                    <th>NPS</th>
                    <th>Comments</th>
                    <th>Actions</th>
                </tr>
            </thead>

            <tbody>

            <% surveys.forEach(s => { 
                 // Hide surveys missing satisfaction score
                 if (!s.SurveySatisfactionScore) return;
            %>

                <tr>
                    <!-- EMAIL -->
                    <td class="nowrap"><%= s.ParticipantEmail %></td>

                    <!-- EVENT -->
                    <td class="nowrap"><%= s.EventName %></td>

                    <!-- START DATE -->
                    <td class="nowrap"><%= s.EventDateTimeStart %></td>

                    <!-- SCORES -->
                    <td class="nowrap"><%= s.SurveySatisfactionScore %></td>
                    <td class="nowrap"><%= s.SurveyUsefulnessScore %></td>
                    <td class="nowrap"><%= s.SurveyInstructorScore %></td>
                    <td class="nowrap"><%= s.SurveyRecommendationScore %></td>
                    <td class="nowrap"><%= s.SurveyOverallScore %></td>
                    <td class="nowrap"><%= s.SurveyNPSBucket %></td>

                    <!-- COMMENTS -->
                    <td class="nowrap">
                        <% if (s.SurveyComments && s.SurveyComments.length > 0) { %>
                            <button class="btn btn-small btn-secondary"
                                    data-comment="<%= s.SurveyComments.replace(/"/g, '&quot;') %>"
                                    onclick="showComment(this.dataset.comment)">
                                View
                            </button>
                        <% } else { %>
                            <span>No comments</span>
                        <% } %>
                    </td>

                    <!-- ACTIONS -->
                    <td class="nowrap actions-column">
                        <a class="btn btn-secondary btn-small"
                           href="/surveys/edit/<%= s.SurveyID %>">
                            Edit
                        </a>

                        <% if (user.level === "M") { %>
                            <form action="/surveys/delete/<%= s.SurveyID %>"
                                  method="POST"
                                  style="display:inline;">
                                <button class="btn btn-danger btn-small"
                                        onclick="return confirm('Delete survey?');">
                                    Delete
                                </button>
                            </form>
                        <% } %>
                    </td>
                </tr>

            <% }) %>

            </tbody>
        </table>

    <% } else { %>
        <p>No surveys recorded.</p>
    <% } %>

</div>

<% if (user.level === "M") { %>
    <a href="/surveys/edit" class="btn btn-primary">Add Survey</a>
<% } %>

<!-- MODAL -->
<div id="commentModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h2>Survey Comment</h2>
        <p id="commentText"></p>
        <button class="btn btn-primary" onclick="closeComment()">Close</button>
    </div>
</div>

<script>
    function showComment(text) {
        document.getElementById("commentText").innerText = text;
        document.getElementById("commentModal").style.display = "flex";
    }
    function closeComment() {
        document.getElementById("commentModal").style.display = "none";
    }
</script>

<%- include("partials/footer") %>
