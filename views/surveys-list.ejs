<%- include("partials/header") %>
<%- include("partials/nav") %>

<div class="page-header">
    <h1 class="section-header">Surveys</h1>

    <% if (user && user.level === "M") { %>
        <a class="btn btn-primary add-btn" href="/surveys/edit">Add Survey</a>
    <% } %>
</div>

<!-- ✅ SEARCH BAR -->
<div class="search-bar">
    <form method="GET" action="/surveys" class="search-bar">
        <input type="text" name="search" placeholder="Search..." value="<%= search %>">
        <button class="btn btn-primary" type="submit">Search</button>
        <a class="btn btn-secondary" href="<%= clearPath %>">Clear</a>
    </form>
</div>

<div class="card">
    <table class="styled-table survey-table">
        <thead>
            <tr>
                <th>Email</th>
                <th>Event Name</th>
                <th>Start</th>
                <th>Satisfaction</th>
                <th>Usefulness</th>
                <th>Instructor</th>
                <th>Recommend</th>
                <th>Overall</th>
                <th>NPS</th>
                <th>Comments</th>
            </tr>
        </thead>

        <tbody>
            <% surveys.forEach(s => { %>
                <tr>
                    <td><%= s.ParticipantEmail %></td>
                    <td><%= s.EventName %></td>
                    <td><%= s.EventDateTimeStart %></td>
                    <td><%= s.SurveySatisfactionScore %></td>
                    <td><%= s.SurveyUsefulnessScore %></td>
                    <td><%= s.SurveyInstructorScore %></td>
                    <td><%= s.SurveyRecommendationScore %></td>
                    <td><%= s.SurveyOverallScore %></td>

                    <!-- ✅ NPS (supports BOTH numbers + text buckets) -->
                    <td class="nps-cell">
                        <%
                            let bucket = null;
                    
                            // ✅ 1. If DB already has a bucket, use it
                            if (s.SurveyNPSBucket && isNaN(s.SurveyNPSBucket)) {
                                bucket = s.SurveyNPSBucket.toString().toLowerCase();
                            }
                    
                            // ✅ 2. Otherwise auto-calculate from Recommend (1–5 → 0–10 → bucket)
                            else if (s.SurveyRecommendationScore !== null && s.SurveyRecommendationScore !== "") {
                                const rec = parseFloat(s.SurveyRecommendationScore);
                                const autoNps = Math.round((rec / 5) * 10);
                    
                                if (autoNps >= 9) bucket = "promoter";
                                else if (autoNps >= 7) bucket = "passive";
                                else bucket = "detractor";
                            }
                    
                            // ✅ 3. Render correct dot
                            if (bucket === "promoter") {
                        %>
                            <span class="nps-dot nps-promoter"></span>
                        <% } else if (bucket === "passive") { %>
                            <span class="nps-dot nps-passive"></span>
                        <% } else if (bucket === "detractor") { %>
                            <span class="nps-dot nps-detractor"></span>
                        <% } else { %>
                            <span class="nps-none">—</span>
                        <% } %>
                    </td>
                    
                    

                    <!-- ✅ COMMENTS (MODAL VIEW) -->
                    <td>
                        <% if (s.SurveyComments && s.SurveyComments.trim() !== "") { %>
                            <button 
                                class="btn btn-secondary btn-small"
                                onclick="openCommentModal(`<%= s.SurveyComments.replace(/`/g, '\\`') %>`)"
                            >
                                View
                            </button>
                        <% } else { %>
                            <span class="nps-none">—</span>
                        <% } %>
                    </td>
                </tr>
            <% }) %>
        </tbody>
    </table>
</div>

<!-- ✅ COMMENTS MODAL (MUST BE OUTSIDE TABLE) -->
<div id="commentModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h3>Survey Comment</h3>
        <p id="commentText"></p>
        <button class="btn btn-primary" onclick="closeCommentModal()">Close</button>
    </div>
</div>

<script>
    function openCommentModal(text) {
        document.getElementById("commentText").innerText = text;
        document.getElementById("commentModal").style.display = "flex";
    }

    function closeCommentModal() {
        document.getElementById("commentModal").style.display = "none";
    }
</script>