<%- include("partials/header") %>
<%- include("partials/nav") %>

<div class="page-header">
    <h1 class="section-header">Participants</h1>

    <% if (user && user.level === "M") { %>
        <a href="/participants/edit" class="btn btn-primary add-btn">Add Participant</a>
    <% } %>
</div>




<!-- SEARCH FORM -->
<br><br><br>

<form method="GET" action="/participants" style="margin-bottom: 1.5rem; display: flex; gap: 0.5rem;">
    <input 
      type="text" 
      name="firstName" 
      placeholder="First name..." 
      value="<%= firstName %>"
      class="form-control"
    >
    <input 
      type="text" 
      name="lastName" 
      placeholder="Last name..." 
      value="<%= lastName %>"
      class="form-control"
    >
    <button type="submit" class="btn btn-primary">Search</button>
    <a href="/participants" class="btn btn-secondary">Clear</a>
  </form>
  
  <!-- RESULTS INFO (Optional) -->
  <% if (firstName || lastName) { %>
    <p style="margin-bottom: 1rem; font-size: 0.95rem; color: #666;">
      Found <%= participants.length %> result(s)
    </p>
  <% } %>
  

<div class="card">
  <% if (participants && participants.length > 0) { %>

    <table class="styled-table">
      <thead>
        <tr>
          <th>Email</th>
          <th>First Name</th>
          <th>Last Name</th>
          <th>DOB</th>
          <th>Role</th>
          <th>Phone</th>
          <th>City</th>
          <th>State</th>
          <th>Zip</th>

          <% if (user.level === "M") { %>
            <th>Actions</th>
          <% } %>
        </tr>
      </thead>

      <tbody>
        <% participants.forEach(p => { 
        
            // 1. FORMAT DATE OF BIRTH (M/D/YYYY)
            // We use timeZone: 'UTC' to ensure the date doesn't shift back by one day
            let dobDisplay = "";
            if (p.ParticipantDOB) {
                dobDisplay = new Date(p.ParticipantDOB).toLocaleDateString("en-US", { timeZone: "UTC" });
            }
  
            // 2. FORMAT PHONE NUMBER (###-###-####)
            let phoneDisplay = p.ParticipantPhone || "";
            // Remove any existing dashes or spaces first so we have clean numbers
            const cleanPhone = phoneDisplay.replace(/\D/g, ""); 
            
            if (cleanPhone.length === 10) {
                phoneDisplay = `${cleanPhone.slice(0,3)}-${cleanPhone.slice(3,6)}-${cleanPhone.slice(6)}`;
            }
        %>
          <tr>
            <td><%= p.ParticipantEmail %></td>
            <td><%= p.ParticipantFirstName %></td>
            <td><%= p.ParticipantLastName %></td>
            
            <td><%= dobDisplay %></td> 
            <td><%= p.ParticipantRole %></td>
            <td><%= phoneDisplay %></td> 
            
            <td><%= p.ParticipantCity %></td>
            <td><%= p.ParticipantState %></td>
            <td><%= p.ParticipantZip %></td>
  
            <% if (user.level === "M") { %>
              <td>
                <div class="action-buttons">
                  <a class="btn btn-secondary btn-small" 
                     href="/participants/edit/<%= p.ParticipantEmail %>">
                    Edit
                  </a>
            
                  <form action="/participants/delete/<%= p.ParticipantEmail %>" 
                        method="POST">
                    <button class="btn btn-danger btn-small" onclick="return confirm('Are you sure?');">
                      Delete
                    </button>
                  </form>
                </div>
              </td>
            <% } %>
          </tr>
        <% }) %>
      </tbody>
    </table>

  <% } else { %>
    <p>No participants found.</p>
  <% } %>


</div>


<%- include("partials/footer") %>